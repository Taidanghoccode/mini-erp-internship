{% extends "base.html" %}
{% set page_title = "Interns" %}
{% block content %}

<style>
    #toast {
        position: fixed;
        top: 20px;
        right: 20px;
        z-index: 99999 !important;
        display: flex;
        flex-direction: column;
        gap: 10px;
    }

    .toast-msg {
        padding: 12px 16px;
        border-radius: 8px;
        background: #333;
        color: #fff;
        animation: fadein 0.2s ease-in-out;
    }

    .toast-success {
        background: #28a745 !important;
    }

    .toast-error {
        background: #dc3545 !important;
    }

    .modal {
        position: fixed;
        inset: 0;
        background: rgba(0, 0, 0, 0.4);
        display: none;
        justify-content: center;
        align-items: center;
    }

    .modal.show {
        display: flex;
    }

    .modal-content {
        background: #fff;
        padding: 20px;
        width: 450px;
        border-radius: 10px;
        box-shadow: 0 4px 20px rgba(0, 0, 0, 0.15);
    }

    .modal input,
    .modal select {
        width: 100%;
        padding: 10px;
        margin: 6px 0;
        border-radius: 6px;
        border: 1px solid #ccc;
    }

    .btn-primary {
        background: #1877f2;
        color: #fff;
        padding: 8px 16px;
        border: none;
        border-radius: 6px;
        cursor: pointer;
    }

    .btn-success {
        background: #28a745;
        color: #fff;
        padding: 8px 16px;
        border: none;
        border-radius: 6px;
        cursor: pointer;
    }

    .btn-icon i {
        font-size: 14px;
    }


    table {
        width: 100%;
        border-collapse: collapse;
    }

    th,
    td {
        padding: 12px 10px;
        border-bottom: 1px solid #e5e7eb;
    }

    thead {
        background: #f8fafc;
    }
</style>

<div id="toast"></div>

<div class="header">
    <h1><i class="fa-solid fa-user-graduate"></i> Interns</h1>
    <div class="filter-row" style="display:flex; gap:10px;">
        <input id="searchInput" placeholder="Search name...">
        <select id="filterMajor">
            <option value="">Major (All)</option>
            <option>IT</option>
            <option>Business</option>
            <option>Design</option>
        </select>
        <button onclick="loadInterns()" class="btn-primary">Search</button>

        <button onclick="openCreateModal()" class="btn-success" data-permission="INTERN_CREATE">
            <i class="fa fa-plus"></i> Add Intern
        </button>
    </div>
</div>

<div class="card">
    <table id="internTable">
        <thead>
            <tr>
                <th>Name</th>
                <th>Email</th>
                <th>University</th>
                <th>Major</th>
                <th>Projects</th>
                <th>Rating</th>
                <th width="120px">Actions</th>
            </tr>
        </thead>
        <tbody></tbody>
    </table>
</div>

<div class="modal" id="internModal">
    <div class="modal-content">
        <h3 id="modalTitle">Add Intern</h3>

        <input id="m-name" placeholder="Name">
        <input id="m-email" placeholder="Email">
        <input id="m-university" placeholder="University">
        <input id="m-major" placeholder="Major">

        <label>User link:</label>
        <select id="m-user">
            <option>-- No linked user --</option>
        </select>

        <div style="margin-top:10px; display:flex; justify-content:flex-end; gap:8px;">
            <button class="btn-primary" onclick="saveIntern()">Save</button>
            <button class="btn-delete" onclick="closeModal()">Close</button>
        </div>
    </div>
</div>

<script>
    let editingId = null;

    function showToast(msg, type = "success") {
        const box = document.getElementById("toast");
        const div = document.createElement("div");
        div.className = `toast-msg toast-${type}`;
        div.innerHTML = msg;
        box.appendChild(div);
        setTimeout(() => div.remove(), 3000);
    }

    function escapeHtml(text) {
        if (!text) return "";
        return text.replace(/&/g, "&amp;")
            .replace(/</g, "&lt;")
            .replace(/>/g, "&gt;")
            .replace(/"/g, "&quot;");
    }

    function openCreateModal() {
        editingId = null;

        document.getElementById("modalTitle").innerText = "Add Intern";
        document.getElementById("m-name").value = "";
        document.getElementById("m-email").value = "";
        document.getElementById("m-university").value = "";
        document.getElementById("m-major").value = "";
        document.getElementById("m-user").value = "";

        loadUsersForIntern();
        document.getElementById("internModal").classList.add("show");
    }

    function openEdit(id, name, email, university, major, userId) {
        editingId = id;

        document.getElementById("modalTitle").innerText = "Edit Intern";
        document.getElementById("m-name").value = name || "";
        document.getElementById("m-email").value = email || "";
        document.getElementById("m-university").value = university || "";
        document.getElementById("m-major").value = major || "";

        loadUsersForIntern(userId);
        document.getElementById("internModal").classList.add("show");
    }

    function closeModal() {
        document.getElementById("internModal").classList.remove("show");
    }

    async function saveIntern() {
        try {
            const payload = {
                name: document.getElementById("m-name").value,
                email: document.getElementById("m-email").value,
                university: document.getElementById("m-university").value,
                major: document.getElementById("m-major").value,
                user_id: document.getElementById("m-user").value || null
            };

            const token = localStorage.getItem("token");
            let url = "/api/interns/";
            let method = "POST";

            if (editingId) {
                url = `/api/interns/${editingId}`;
                method = "PUT";
            }

            const res = await fetch(url, {
                method,
                headers: {
                    "Content-Type": "application/json",
                    "Authorization": "Bearer " + token
                },
                body: JSON.stringify(payload)
            });

            const data = await res.json();

            if (!res.ok) {
                showToast(data.error || (editingId ? "Update failed" : "Create failed"), "error");
                return;
            }

            showToast(editingId ? "Intern updated successfully" : "Intern created successfully");
            closeModal();
            loadInterns();

        } catch (err) {
            showToast("Connection error!", "error");
        }
    }

    async function loadInterns() {
        try {
            const res = await fetch("/api/interns/", {
                headers: { "Authorization": "Bearer " + localStorage.getItem("token") }
            });

            const data = await res.json();
            if (!res.ok) {
                showToast("Error loading interns", "error");
                return;
            }

            let interns = data;
            const keyword = document.getElementById("searchInput").value.toLowerCase();
            const majorFilter = document.getElementById("filterMajor").value;

            interns = interns.filter(i =>
                i.name.toLowerCase().includes(keyword) &&
                (majorFilter === "" || i.major === majorFilter)
            );

            const tbody = document.querySelector("#internTable tbody");
            tbody.innerHTML = "";

            interns.forEach(i => {
                const name = escapeHtml(i.name);
                const email = escapeHtml(i.email);
                const uni = escapeHtml(i.university || "-");
                const major = escapeHtml(i.major || "-");
                const rating = i.avg_rating ?? "-";
                const userIdExpr = (i.user_id ?? "null");

                tbody.innerHTML += `
                <tr>
                    <td>${name}</td>
                    <td>${email}</td>
                    <td>${uni}</td>
                    <td>${major}</td>
                    <td>${i.project_count || 0}</td>
                    <td>${rating}</td>
                    <td>
                        <button class="btn-icon btn-view" onclick="viewDetail(${i.id})">
                            <i class="fa-solid fa-eye"></i>
                        </button>
                        <button class="btn-icon btn-edit"
                                data-permission="INTERN_UPDATE"
                                onclick="openEdit(${i.id}, '${name}', '${email}', '${uni}', '${major}', ${userIdExpr})">
                            <i class="fa-solid fa-pen"></i>
                        </button>
                        <button class="btn-icon btn-delete" 
                                data-permission="INTERN_DELETE"
                                onclick="deleteIntern(${i.id})">
                            <i class="fa-solid fa-trash"></i>
                        </button>
                    </td>
                </tr>`;
            });

            if (window.applyPermissionUI) {
                window.applyPermissionUI(tbody);
            }

        } catch (err) {
            showToast("Connection error!", "error");
        }
    }

    function viewDetail(id) {
        window.location.href = `/interns/${id}`;
    }

    async function loadUsersForIntern(currentUserId = null) {
        const sel = document.getElementById("m-user");
        sel.innerHTML = `<option value="">-- No linked user --</option>`;

        try {
            const res = await fetch("/api/users/", {
                headers: { "Authorization": "Bearer " + localStorage.getItem("token") }
            });

            const users = await res.json();
            if (!res.ok) {
                showToast(users.error || "Error loading users", "error");
                return;
            }

            users.forEach(u => {
                sel.innerHTML += `<option value="${u.id}">${escapeHtml(u.username)} (${escapeHtml(u.email)})</option>`;
            });

            if (currentUserId) sel.value = currentUserId;

        } catch (err) {
            showToast("Connection error", "error");
        }
    }

    async function deleteIntern(id) {
        if (!confirm("Delete this intern?")) return;

        try {
            const res = await fetch(`/api/interns/${id}`, {
                method: "DELETE",
                headers: { "Authorization": "Bearer " + localStorage.getItem("token") }
            });

            if (!res.ok) {
                const err = await res.json();
                showToast(err.error || "Delete failed", "error");
                return;
            }

            showToast("Deleted successfully", "info");
            loadInterns();

        } catch (err) {
            showToast("Connection error", "error");
        }
    }

    loadInterns();
</script>

{% endblock %}