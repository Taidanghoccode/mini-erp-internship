{% extends "base.html" %}
{% set page_title = "Reports" %}
{% block content %}

<style>
    /* ========= TABS ========= */
    .report-tabs {
        display: flex;
        gap: 10px;
        border-bottom: 2px solid #eee;
        margin-bottom: 20px;
        padding-bottom: 4px;
    }

    .rtab {
        padding: 10px 18px;
        background: #f3f4f6;
        border: none;
        border-radius: 8px 8px 0 0;
        cursor: pointer;
        font-size: 14px;
        font-weight: 500;
        color: #555;
        transition: 0.25s;
    }

    .rtab:hover {
        background: #e5e7eb;
    }

    .rtab.active {
        background: #fff;
        color: #111;
        border-bottom: 2px solid #3b82f6;
        font-weight: 600;
    }

    .tab-pane {
        display: none;
    }

    .tab-pane.active {
        display: block;
    }

    /* ========= KPI CARDS ========= */
    .kpi-grid {
        display: grid;
        grid-template-columns: repeat(auto-fit, minmax(240px, 1fr));
        gap: 15px;
        margin-top: 10px;
        margin-bottom: 25px;
    }

    .kpi-card {
        background: #fff;
        padding: 18px;
        border-radius: 10px;
        display: flex;
        gap: 14px;
        align-items: center;
        border-left: 4px solid var(--clr);
        box-shadow: 0 2px 6px rgba(0, 0, 0, .06);
    }

    .kpi-icon {
        width: 48px;
        height: 48px;
        border-radius: 8px;
        background: var(--clr-light);
        color: var(--clr);
        font-size: 22px;
        display: flex;
        align-items: center;
        justify-content: center;
    }

    .kpi-label {
        font-size: 13px;
        color: #666;
        font-weight: 600;
    }

    .kpi-value {
        font-size: 28px;
        font-weight: 700;
        color: #333;
    }

    /* ========= CHARTS ========= */
    .chart-grid {
        display: grid;
        grid-template-columns: repeat(auto-fit, minmax(300px, 1fr));
        gap: 20px;
        margin-top: 10px;
    }

    .chart-card {
        background: #fff;
        padding: 20px;
        border-radius: 10px;
        box-shadow: 0 2px 6px rgba(0, 0, 0, .06);
        max-height: 350px;
    }

    .chart-card h4 {
        margin: 0 0 15px 0;
        font-size: 15px;
        color: #333;
    }

    .chart-card canvas {
        max-height: 250px !important;
    }

    .chart-card.wide {
        margin-top: 20px;
        grid-column: 1 / -1;
        max-height: 400px;
    }

    .chart-card.wide canvas {
        max-height: 300px !important;
    }

    /* ========= TABLE ========= */
    .table-wrapper {
        overflow-x: auto;
        margin-top: 15px;
    }

    table {
        width: 100%;
        border-collapse: collapse;
        background: #fff;
    }

    thead th {
        background: #f8f9fa;
        padding: 12px;
        font-weight: 600;
        border-bottom: 2px solid #e5e7eb;
        color: #111;
        text-align: left;
        white-space: nowrap;
    }

    tbody td {
        padding: 12px;
        border-bottom: 1px solid #eee;
        color: #444;
    }

    tbody tr:nth-child(even) {
        background: #fafafa;
    }

    tbody tr:hover {
        background: #f0f9ff;
    }

    /* ========= FILTERS ========= */
    .filter-row {
        display: flex;
        gap: 10px;
        flex-wrap: wrap;
        align-items: center;
        margin: 12px 0;
        padding: 15px;
        background: #f8f9fa;
        border-radius: 8px;
    }

    .filter-row select,
    .filter-row input {
        padding: 8px 12px;
        border: 1px solid #ddd;
        border-radius: 6px;
        font-size: 14px;
    }

    .info-box {
        padding: 12px;
        background: #e7f3ff;
        border-left: 4px solid #2196F3;
        border-radius: 4px;
        margin: 10px 0;
        font-size: 14px;
    }

    .export-status {
        margin-top: 15px;
        padding: 14px;
        border-radius: 8px;
        font-size: 14px;
        display: none;
    }

    .btn-primary {
        padding: 8px 16px;
        background: #3b82f6;
        color: white;
        border: none;
        border-radius: 6px;
        cursor: pointer;
        font-weight: 500;
        transition: 0.2s;
    }

    .btn-primary:hover {
        background: #2563eb;
    }

    .empty-state {
        text-align: center;
        padding: 40px;
        color: #999;
    }
</style>

<!-- HEADER -->
<div class="header">
    <h1><i class="fa-solid fa-chart-pie"></i> Reports & Analytics</h1>
    <p style="color:#666;">Performance Overview ‚Ä¢ Detailed Reports ‚Ä¢ Data Export</p>
</div>

<!-- TOP TABS -->
<div class="report-tabs">
    <button class="rtab active" data-tab="overview"><i class="fa-solid fa-chart-line"></i> Overview</button>
    <button class="rtab" data-tab="detail"><i class="fa-solid fa-table"></i> Detailed Reports</button>
    <button class="rtab" data-tab="export"><i class="fa-solid fa-file-export"></i> Export Reports</button>
</div>

<!-- ===================== OVERVIEW PANEL ===================== -->
<div id="tab-overview" class="tab-pane active">

    <div class="filter-row">
        <strong>Filters:</strong>
        <input type="date" id="overview_from" placeholder="From date">
        <input type="date" id="overview_to" placeholder="To date">
        <select id="overview_major">
            <option value="">All Majors</option>
            <option value="IT">Information Technology</option>
            <option value="Business">Business</option>
            <option value="Marketing">Marketing</option>
        </select>
    </div>

    <!-- KPI CARDS -->
    <div id="kpiGrid" class="kpi-grid">
        <p style="text-align:center; color:#999;">Loading data...</p>
    </div>

    <!-- CHARTS -->
    <div id="chartsWrapper" style="display:none;">
        <div class="chart-grid">
            <div class="chart-card">
                <h4><i class="fa-solid fa-chart-pie"></i> Project Status</h4>
                <canvas id="statusChart"></canvas>
            </div>

            <div class="chart-card">
                <h4><i class="fa-solid fa-user-graduate"></i> Intern Rating (10 points)</h4>
                <canvas id="internRatingChart"></canvas>
            </div>

            <div class="chart-card">
                <h4><i class="fa-solid fa-star"></i> Project Rating (5 stars)</h4>
                <canvas id="projectRatingChart"></canvas>
            </div>
        </div>

        <div class="chart-card wide">
            <h4><i class="fa-solid fa-users"></i> Students by Major</h4>
            <canvas id="majorChart"></canvas>
        </div>
    </div>
</div>

<!-- ===================== DETAILED REPORTS PANEL ===================== -->
<div id="tab-detail" class="tab-pane">

    <h3><i class="fa-solid fa-table-list"></i> Detailed Reports</h3>

    <div class="filter-row">
        <select id="view_type">
            <option value="intern">Interns</option>
            <option value="project">Projects</option>
            <option value="feedback">Feedback</option>
        </select>

        <input type="date" id="view_from" placeholder="From date">
        <input type="date" id="view_to" placeholder="To date">

        <select id="view_major">
            <option value="">All Majors</option>
            <option value="IT">Information Technology</option>
            <option value="Business">Business</option>
            <option value="Marketing">Marketing</option>
        </select>

        <select id="view_status">
            <option value="">All</option>
            <option value="active">Active</option>
            <option value="done">Completed</option>
        </select>

        <button class="btn-primary" id="btnViewReport" title="Or change filters to auto-reload">
            <i class="fa-solid fa-rotate"></i> Refresh
        </button>
    </div>

    <div id="viewInfo" class="info-box" style="display:none;">
        <span id="viewInfoText"></span>
    </div>

    <div class="table-wrapper">
        <table>
            <thead id="viewHead"></thead>
            <tbody id="viewBody"></tbody>
        </table>
    </div>

    <div id="viewEmpty" class="empty-state"></div>
</div>

<!-- ===================== EXPORT PANEL ===================== -->
<div id="tab-export" class="tab-pane">

    <h3><i class="fa-solid fa-file-export"></i> Export Excel Reports</h3>

    <div class="filter-row">
        <select id="export_type">
            <option value="all">üìä Comprehensive Report (All - 3 sheets)</option>
            <option value="intern">üë• Interns Report</option>
            <option value="project">üìÅ Projects Report</option>
            <option value="feedback">‚≠ê Feedback Report</option>
        </select>

        <input type="date" id="export_from" placeholder="From date">
        <input type="date" id="export_to" placeholder="To date">

        <select id="export_major">
            <option value="">All Majors</option>
            <option value="IT">Information Technology</option>
            <option value="Business">Business</option>
            <option value="Marketing">Marketing</option>
        </select>

        <select id="export_status">
            <option value="">All</option>
            <option value="active">Active</option>
            <option value="done">Completed</option>
        </select>

        <button class="btn-primary" id="btnExport"><i class="fa-solid fa-download"></i> Export File</button>
    </div>

    <div id="exportStatus" class="export-status"></div>

</div>

<!-- ========== JS SECTION ========== -->
<script src="https://cdnjs.cloudflare.com/ajax/libs/Chart.js/3.9.1/chart.min.js"></script>

<script>
    /* ---------- Tab Switching ---------- */
    document.querySelectorAll(".rtab").forEach(btn => {
        btn.onclick = () => {
            document.querySelectorAll(".rtab").forEach(x => x.classList.remove("active"));
            document.querySelectorAll(".tab-pane").forEach(p => p.classList.remove("active"));
            btn.classList.add("active");
            document.getElementById("tab-" + btn.dataset.tab).classList.add("active");
        };
    });

    /* ---------- API & Variables ---------- */
    const $ = id => document.getElementById(id);
    const API_HEADERS = { "X-User-ID": 1 };
    let charts = { status: null, internRating: null, projectRating: null, major: null };

    /* ---------- AUTO LOAD ON PAGE LOAD ---------- */
    window.addEventListener("DOMContentLoaded", () => {
        loadOverview();
        loadDetailedReport();
    });

    /* ---------- FILTER CHANGE AUTO RELOAD ---------- */
    ["overview_from", "overview_to", "overview_major"].forEach(id => {
        $(id).addEventListener("change", loadOverview);
    });

    ["view_type", "view_from", "view_to", "view_major", "view_status"].forEach(id => {
        $(id).addEventListener("change", loadDetailedReport);
    });

    /* ========== LOAD OVERVIEW ========== */
    async function loadOverview() {
        const params = new URLSearchParams();
        if ($("overview_from").value) params.append("from_date", $("overview_from").value);
        if ($("overview_to").value) params.append("to_date", $("overview_to").value);
        if ($("overview_major").value) params.append("major", $("overview_major").value);

        $("kpiGrid").innerHTML = "<p style='text-align:center;color:#999;'>Loading...</p>";
        $("chartsWrapper").style.display = "none";

        try {
            const res = await fetch("/api/reports/statistics?" + params, { headers: API_HEADERS });

            if (!res.ok) {
                let errorMsg = `HTTP ${res.status}`;
                try {
                    const err = await res.json();
                    errorMsg = err.error || err.message || errorMsg;
                } catch (e) {
                    errorMsg = await res.text();
                }
                throw new Error(errorMsg);
            }

            const contentType = res.headers.get("content-type");
            if (!contentType || !contentType.includes("application/json")) {
                const text = await res.text();
                console.error("Response is not JSON:", text);
                throw new Error("API response is not in the correct format. Check console.");
            }

            const data = await res.json();

            /* Render KPIs */
            const stats = [
                { label: "Total Interns", value: data.intern_count || 0, icon: "fa-users", clr: "#2196F3" },
                { label: "Total Projects", value: data.project_total || 0, icon: "fa-diagram-project", clr: "#9c27b0" },
                { label: "Completed", value: data.project_completed || 0, icon: "fa-check-circle", clr: "#4caf50" },
                { label: "In Progress", value: data.project_in_progress || 0, icon: "fa-clock", clr: "#ff9800" },
                { label: "Completion Rate", value: ((data.project_completion_rate || 0) * 100).toFixed(1) + "%", icon: "fa-chart-pie", clr: "#00bcd4" },
                { label: "Avg Rating", value: data.average_rating || 0, icon: "fa-star", clr: "#ffc107" }
            ];

            $("kpiGrid").innerHTML = "";
            stats.forEach(s => {
                $("kpiGrid").innerHTML += `
                <div class="kpi-card" style="--clr:${s.clr}; --clr-light:${s.clr}20">
                    <div class="kpi-icon"><i class="fa-solid ${s.icon}"></i></div>
                    <div>
                        <div class="kpi-label">${s.label}</div>
                        <div class="kpi-value">${s.value}</div>
                    </div>
                </div>
            `;
            });

            renderCharts(data);
        }
        catch (e) {
            console.error("Load overview error:", e);
            $("kpiGrid").innerHTML = `<p style="text-align:center;color:#f44336;">‚ùå Error: ${e.message}<br><small>Check: does route /api/reports/statistics exist?</small></p>`;
        }
    }

    /* ========== CHARTS ========== */
    function renderCharts(data) {
        /* Destroy old charts */
        Object.values(charts).forEach(c => c?.destroy());

        $("chartsWrapper").style.display = "block";

        /* Status Chart */
        charts.status = new Chart($("statusChart"), {
            type: "doughnut",
            data: {
                labels: ["Completed", "In Progress"],
                datasets: [{
                    data: [data.project_completed || 0, data.project_in_progress || 0],
                    backgroundColor: ["#4caf50", "#ff9800"],
                    borderWidth: 0
                }]
            },
            options: {
                responsive: true,
                maintainAspectRatio: true,
                aspectRatio: 1.5,
                plugins: {
                    legend: { position: "bottom" }
                }
            }
        });

        /* Intern Rating Chart - Scale 0-10 */
        const internRd = data.intern_rating_distribution || { excellent: 0, good: 0, average: 0, poor: 0 };
        charts.internRating = new Chart($("internRatingChart"), {
            type: "bar",
            data: {
                labels: ["Excellent\n(9-10)", "Good\n(7-8)", "Average\n(5-6)", "Poor\n(<5)"],
                datasets: [{
                    data: [internRd.excellent || 0, internRd.good || 0, internRd.average || 0, internRd.poor || 0],
                    backgroundColor: ["#4caf50", "#2196F3", "#ff9800", "#f44336"]
                }]
            },
            options: {
                responsive: true,
                maintainAspectRatio: true,
                aspectRatio: 1.5,
                scales: { y: { beginAtZero: true, ticks: { stepSize: 1 } } },
                plugins: { legend: { display: false } }
            }
        });

        /* Project Rating Chart - Scale 1-5 stars */
        const projectRd = data.project_rating_distribution || { "5_star": 0, "4_star": 0, "3_star": 0, "2_star": 0, "1_star": 0 };
        charts.projectRating = new Chart($("projectRatingChart"), {
            type: "bar",
            data: {
                labels: ["‚≠ê‚≠ê‚≠ê‚≠ê‚≠ê", "‚≠ê‚≠ê‚≠ê‚≠ê", "‚≠ê‚≠ê‚≠ê", "‚≠ê‚≠ê", "‚≠ê"],
                datasets: [{
                    data: [
                        projectRd["5_star"] || 0,
                        projectRd["4_star"] || 0,
                        projectRd["3_star"] || 0,
                        projectRd["2_star"] || 0,
                        projectRd["1_star"] || 0
                    ],
                    backgroundColor: ["#4caf50", "#8bc34a", "#ffc107", "#ff9800", "#f44336"]
                }]
            },
            options: {
                responsive: true,
                maintainAspectRatio: true,
                aspectRatio: 1.5,
                scales: { y: { beginAtZero: true, ticks: { stepSize: 1 } } },
                plugins: { legend: { display: false } }
            }
        });

        /* Major Chart */
        const majorData = data.major_stats || {};
        const majorKeys = Object.keys(majorData);

        if (majorKeys.length > 0) {
            charts.major = new Chart($("majorChart"), {
                type: "bar",
                data: {
                    labels: majorKeys,
                    datasets: [{
                        label: "Number of students",
                        data: Object.values(majorData),
                        backgroundColor: "#2196F3"
                    }]
                },
                options: {
                    responsive: true,
                    maintainAspectRatio: true,
                    aspectRatio: 2.5,
                    indexAxis: 'y',
                    scales: { x: { beginAtZero: true } },
                    plugins: { legend: { display: false } }
                }
            });
        } else {
            const canvas = $("majorChart");
            const parent = canvas.parentElement;
            parent.innerHTML = '<p style="text-align:center;color:#999;padding:20px;">No student data available</p>';
        }
    }

    /* ========== DETAILED REPORT VIEW ========== */
    async function loadDetailedReport() {

        const params = new URLSearchParams({
            type: $("view_type").value
        });

        if ($("view_from").value) params.append("from_date", $("view_from").value);
        if ($("view_to").value) params.append("to_date", $("view_to").value);
        if ($("view_major").value) params.append("major", $("view_major").value);
        if ($("view_status").value) params.append("status", $("view_status").value);

        $("viewHead").innerHTML = "";
        $("viewBody").innerHTML = "";
        $("viewInfo").style.display = "none";
        $("viewEmpty").innerHTML = "<p>Loading...</p>";

        try {
            const res = await fetch("/api/reports/view?" + params, { headers: API_HEADERS });

            if (!res.ok) {
                let errorMsg = `HTTP ${res.status}`;
                try {
                    const err = await res.json();
                    errorMsg = err.error || err.message || errorMsg;
                } catch (e) {
                    errorMsg = await res.text();
                }
                throw new Error(errorMsg);
            }

            const contentType = res.headers.get("content-type");
            if (!contentType || !contentType.includes("application/json")) {
                const text = await res.text();
                console.error("Response is not JSON:", text);
                throw new Error("API response is not in the correct format. Check console.");
            }

            const data = await res.json();

            if (!data.length) {
                $("viewEmpty").innerHTML = "<p>No data available.</p>";
                return;
            }

            $("viewEmpty").innerHTML = "";
            $("viewInfo").style.display = "block";
            $("viewInfoText").innerText = `Found ${data.length} records`;

            const keys = Object.keys(data[0]);
            const headRow = document.createElement("tr");
            keys.forEach(k => {
                const th = document.createElement("th");
                th.innerText = k.replace(/_/g, " ").replace(/\b\w/g, l => l.toUpperCase());
                headRow.appendChild(th);
            });
            $("viewHead").appendChild(headRow);

            data.forEach(row => {
                const tr = document.createElement("tr");
                keys.forEach(k => {
                    const td = document.createElement("td");
                    td.innerText = row[k] ?? "-";
                    tr.appendChild(td);
                });
                $("viewBody").appendChild(tr);
            });
        }
        catch (e) {
            console.error("Load detailed report error:", e);
            $("viewEmpty").innerHTML = `<p style="color:#f44336;">‚ùå Error: ${e.message}<br><small>Check: does route /api/reports/view exist?</small></p>`;
        }
    }

    $("btnViewReport").onclick = loadDetailedReport;

    /* ========== EXPORT REPORT ========== */
    $("btnExport").onclick = async () => {

        const payload = {
            type: $("export_type").value,
            format: "excel",
            from_date: $("export_from").value || null,
            to_date: $("export_to").value || null,
            major: $("export_major").value || null,
            status: $("export_status").value || null
        };

        $("exportStatus").style.display = "block";
        $("exportStatus").style.background = "#e7f3ff";
        $("exportStatus").style.borderLeft = "4px solid #2196F3";
        $("exportStatus").innerHTML = "Creating file...";

        try {
            const res = await fetch("/api/reports/export", {
                method: "POST",
                headers: { ...API_HEADERS, "Content-Type": "application/json" },
                body: JSON.stringify(payload)
            });

            if (!res.ok) {
                const err = await res.json();
                throw new Error(err.error || "Export file error");
            }

            const blob = await res.blob();
            const url = URL.createObjectURL(blob);

            const a = document.createElement("a");
            a.href = url;
            a.download = `report_${payload.type}_${new Date().getTime()}.xlsx`;
            a.click();

            $("exportStatus").style.background = "#e8f5e9";
            $("exportStatus").style.borderLeft = "4px solid #4caf50";
            $("exportStatus").innerHTML = "File downloaded successfully!";
        }
        catch (e) {
            $("exportStatus").style.background = "#ffebee";
            $("exportStatus").style.borderLeft = "4px solid #f44336";
            $("exportStatus").innerHTML = "Error: " + e.message;
        }
    };
    async function loadMajors() {
        const token = localStorage.getItem("token");
        const res = await fetch("/api/reports/majors", {
            headers: { "Authorization": "Bearer " + token }
        });

        const majors = await res.json();
        ["overview_major", "view_major", "export_major"].forEach(id => {
            const sel = document.getElementById(id);
            if (!sel) return;
            sel.innerHTML = `<option value="">All Majors</option>`;
            majors.forEach(m => {
                sel.innerHTML += `<option value="${m}">${m}</option>`;
            });
        });
    }

    window.addEventListener("DOMContentLoaded", () => {
        loadMajors();
        loadOverview();
        loadDetailedReport();
    });

</script>

{% endblock %}