{% extends "base.html" %}
{% set page_title = "Settings" %}
{% block content %}

<div id="toast" style="position:fixed;top:20px;right:20px;z-index:99999;display:flex;flex-direction:column;gap:10px;">
</div>

<script>
    function showToast(msg, type = "success") {
        const colors = { success: "#16a34a", error: "#dc2626", info: "#2563eb" };
        const t = document.createElement("div");
        t.style = `
        background:${colors[type]};
        color:white;
        padding:12px 16px;
        border-radius:6px;
        font-weight:600;
        box-shadow:0 2px 6px rgba(0,0,0,.2);
        opacity:0;
        transition:all .3s ease;
    `;
        t.innerText = msg;
        document.getElementById("toast").appendChild(t);
        setTimeout(() => t.style.opacity = 1, 10);
        setTimeout(() => {
            t.style.opacity = 0;
            setTimeout(() => t.remove(), 300);
        }, 2500);
    }
</script>

<div class="header">
    <h1><i class="fa-solid fa-gear"></i> Settings</h1>
</div>

<div class="settings-container">

    <div class="settings-menu">
        <button class="set-btn active" onclick="showTab('general', this)">General</button>
        <button class="set-btn" onclick="showTab('activity', this)">Activity Logs</button>
        <button class="set-btn" onclick="showTab('security', this)">Security</button>
    </div>

    <div class="settings-content">

        <div id="tab-general" class="tab active">
            <h2>General Settings</h2>
            <p>Update your personal settings.</p>
        </div>

        <div id="tab-activity" class="tab">
            <h2>Activity Logs</h2>
            <div id="activityList" class="log-container"></div>
        </div>

        <div id="tab-security" class="tab">
            <h2>Security</h2>
            <button class="btn-primary" onclick="openChangePasswordModal()">Change Password</button>
        </div>

    </div>
</div>

<div id="changePasswordModal" class="modal">
    <div class="modal-content">
        <div class="modal-header">
            <h3>Change Password</h3>
            <span class="close" onclick="closeChangePasswordModal()">&times;</span>
        </div>
        <div class="modal-body">
            <form id="changePasswordForm">
                <div class="form-group">
                    <label for="oldPassword">Current Password</label>
                    <input type="password" id="oldPassword" name="oldPassword" required>
                </div>
                <div class="form-group">
                    <label for="newPassword">New Password</label>
                    <input type="password" id="newPassword" name="newPassword" required minlength="6">
                    <small id="passwordHelp" class="help-text">Must be at least 6 characters</small>
                </div>
                <div class="form-group">
                    <label for="confirmPassword">Confirm New Password</label>
                    <input type="password" id="confirmPassword" name="confirmPassword" required>
                    <small id="confirmHelp" class="help-text"></small>
                </div>
            </form>
        </div>
        <div class="modal-footer">
            <button class="btn-secondary" onclick="closeChangePasswordModal()">Cancel</button>
            <button class="btn-primary" onclick="submitChangePassword()">Change Password</button>
        </div>
    </div>
</div>

<script>
    const CAN_DELETE = {{ ("USER_MANAGE" in permissions) | tojson }};
    console.log("Can delete logs:", CAN_DELETE);
    console.log("Permissions:", {{ permissions | tojson }});

    function showTab(name, btn) {
        document.querySelectorAll(".tab").forEach(t => t.classList.remove("active"));
        document.querySelectorAll(".set-btn").forEach(b => b.classList.remove("active"));

        document.getElementById(`tab-${name}`).classList.add("active");
        btn.classList.add("active");

        if (name === "activity") loadLogs();
    }

    async function loadLogs() {
        const res = await fetch("/api/activity-logs/", {
            headers: { "X-User-ID": "{{ current_user.id }}" }
        });
        const data = await res.json();

        const box = document.getElementById("activityList");

        if (!Array.isArray(data) || !data.length) {
            box.innerHTML = "<p>No logs available.</p>";
            return;
        }

        box.innerHTML = data.map(log => `
        <div class="log-item">
            <div class="log-content">
                <b>${log.action}</b> — ${log.details}
                <div class="time">${log.timestamp}</div>
            </div>
            
        </div>
    `).join("");
    }

    function openChangePasswordModal() {
        document.getElementById("changePasswordModal").style.display = "block";
        document.getElementById("changePasswordForm").reset();
        document.getElementById("passwordHelp").textContent = "Must be at least 6 characters";
        document.getElementById("passwordHelp").className = "help-text";
        document.getElementById("confirmHelp").textContent = "";
        document.getElementById("confirmHelp").className = "help-text";
    }

    function closeChangePasswordModal() {
        document.getElementById("changePasswordModal").style.display = "none";
        document.getElementById("changePasswordForm").reset();
    }

    document.addEventListener('DOMContentLoaded', function () {
        const newPasswordInput = document.getElementById("newPassword");
        const confirmPasswordInput = document.getElementById("confirmPassword");
        const passwordHelp = document.getElementById("passwordHelp");
        const confirmHelp = document.getElementById("confirmHelp");

        if (newPasswordInput) {
            newPasswordInput.addEventListener('input', function () {
                const password = this.value;

                if (password.length === 0) {
                    passwordHelp.textContent = "Must be at least 6 characters";
                    passwordHelp.className = "help-text";
                } else if (password.length < 6) {
                    passwordHelp.textContent = `Too short (${password.length}/6 characters)`;
                    passwordHelp.className = "help-text error";
                } else {
                    passwordHelp.textContent = "Good password ✓";
                    passwordHelp.className = "help-text success";
                }

                if (confirmPasswordInput.value.length > 0) {
                    validateConfirmPassword();
                }
            });
        }

        if (confirmPasswordInput) {
            confirmPasswordInput.addEventListener('input', validateConfirmPassword);
        }

        function validateConfirmPassword() {
            const newPassword = newPasswordInput.value;
            const confirmPassword = confirmPasswordInput.value;

            if (confirmPassword.length === 0) {
                confirmHelp.textContent = "";
                confirmHelp.className = "help-text";
            } else if (newPassword !== confirmPassword) {
                confirmHelp.textContent = "Passwords do not match ✗";
                confirmHelp.className = "help-text error";
            } else {
                confirmHelp.textContent = "Passwords match ✓";
                confirmHelp.className = "help-text success";
            }
        }
    });

    async function submitChangePassword() {
        const oldPassword = document.getElementById("oldPassword").value;
        const newPassword = document.getElementById("newPassword").value;
        const confirmPassword = document.getElementById("confirmPassword").value;

        if (!oldPassword || !newPassword || !confirmPassword) {
            showToast("Please fill in all fields", "error");
            return;
        }

        if (newPassword.length < 6) {
            showToast("New password must be at least 6 characters", "error");
            return;
        }

        if (newPassword !== confirmPassword) {
            showToast("New passwords do not match", "error");
            return;
        }

        try {
            const res = await fetch("/api/auth/change-password", {
                method: "POST",
                headers: {
                    "Content-Type": "application/json"
                },
                body: JSON.stringify({
                    old_password: oldPassword,
                    new_password: newPassword
                })
            });

            const data = await res.json();

            if (!res.ok) {
                showToast(data.error || "Failed to change password", "error");
                return;
            }

            showToast("Password changed successfully", "success");
            closeChangePasswordModal();

            if (document.getElementById("tab-activity").classList.contains("active")) {
                loadLogs();
            }
        } catch (error) {
            console.error("Change password error:", error);
            showToast("An error occurred", "error");
        }
    }

    window.onclick = function (event) {
        const modal = document.getElementById("changePasswordModal");
        if (event.target === modal) {
            closeChangePasswordModal();
        }
    }
</script>



{% endblock %}