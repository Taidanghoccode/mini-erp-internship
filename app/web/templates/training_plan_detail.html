{% extends "base.html" %}
{% set page_title = "Training Plan Detail" %}
{% block content %}

<div id="toast"></div>

<style>
#toast {
    position: fixed;
    top: 20px;
    right: 20px;
    z-index: 99999 !important;
    display: flex;
    flex-direction: column;
    gap: 10px;
}
.toast-msg {
    padding: 12px 16px;
    border-radius: 8px;
    color: #fff;
    animation: fadein .2s ease, fadeout .35s ease-out 2.5s forwards;
}
.toast-success { background: #16a34a !important; }
.toast-error { background: #dc2626 !important; }
.toast-info { background: #2563eb !important; }

@keyframes fadein { from {opacity:0; transform:translateY(-8px);} to {opacity:1;} }
@keyframes fadeout { from {opacity:1;} to {opacity:0; transform:translateY(-8px);} }

.modal {
    position: fixed;
    inset: 0;
    background: rgba(0,0,0,.45);
    display: none;
    justify-content: center;
    align-items: center;
}
.modal.show { display: flex; }

.modal-content {
    background: white;
    width: 480px;
    max-height: 90vh;
    overflow-y: auto;
    padding: 20px;
    border-radius: 12px;
    box-shadow: 0 6px 24px rgba(0,0,0,.15);
}

.builder-box {
    background:#f8fafc;
    padding:10px;
    border-radius:8px;
    border:1px solid #e5e7eb;
    display:flex;
    flex-direction:column;
    gap:10px;
}
.builder-entry {
    display:flex;
    gap:10px;
    align-items:center;
}
.btn-remove {
    background:#dc2626;
    color:white;
    padding:4px 10px;
    border-radius:6px;
}
</style>

<div class="header">
    <h1><i class="fa-solid fa-book-open"></i> {{ plan.title }}</h1>
</div>

<div style="display:grid;grid-template-columns:2fr 1.2fr;gap:20px;">
    <div>
        <div class="card">
            <h3>Training Plan Information</h3>
            <table class="detail-table">
                <tr><th>Title</th><td>{{ plan.title }}</td></tr>
                <tr><th>Description</th><td>{{ plan.description or "-" }}</td></tr>
                <tr><th>Objective</th><td>{{ plan.objective or "-" }}</td></tr>
                <tr><th>Skills</th><td>{{ plan.skills or "-" }}</td></tr>
                <tr>
                    <th>Intern</th>
                    <td>
                        {% if intern %}
                             {{ intern.name }} ({{ intern.email }})
                        {% else %}
                        -
                        {% endif %}
                    </td>
                </tr>
                <tr><th>Created By</th><td>{{ plan.created_by_name or ("User #" ~ plan.created_by) }}</td></tr>
                <tr><th>Created At</th><td>{{ plan.created_at }}</td></tr>
                <tr><th>Updated At</th><td>{{ plan.updated_at }}</td></tr>
            </table>
        </div>

        <div class="card" style="margin-top:20px;">
            <h3>Timeline</h3>
            <div id="timelineBox"></div>
        </div>
    </div>

    <div>
        <div class="card">
            <h3>Progress</h3>
            <div style="background:#e5e7eb;border-radius:6px;height:16px;width:100%;">
                <div style="background:#3b82f6;height:16px;width:{{ plan.progress }}%;"></div>
            </div>
            <div style="margin-top:8px;">{{ plan.progress }}% completed</div>

            {% if current_user.role.code == "INTERN" %}
            <button onclick="openInternProgressEdit()" class="btn-primary" style="margin-top:15px;width:100%;">Update Progress</button>
            {% endif %}

            {% if "TRAININGPLAN_UPDATE" in permissions %}
            <button onclick="openEdit()" class="btn-primary" style="margin-top:15px;width:100%;">Edit Training Plan</button>
            {% endif %}

            {% if "TRAININGPLAN_DELETE" in permissions %}
            <button onclick="deletePlan()" class="btn-danger" style="margin-top:10px;width:100%;">Delete Training Plan</button>
            {% endif %}
        </div>

        <div class="card" style="margin-top:20px;">
            <h3>Resources</h3>
            <ul id="resourceList"></ul>
        </div>
    </div>
</div>

<div class="modal" id="modalEdit">
    <div class="modal-content">
        <h3>Edit Training Plan</h3>
        <input id="m-title" value="{{ plan.title }}">
        <textarea id="m-description">{{ plan.description }}</textarea>
        <input id="m-objective" value="{{ plan.objective }}">
        <input id="m-skills" value="{{ plan.skills }}">

        <label>Timeline</label>
        <div id="timelineBuilder" class="builder-box"></div>
        <button onclick="addEntry('timeline')" class="btn-primary" style="margin-top:10px;">+ Add Timeline</button>

        <label>Documents</label>
        <div id="docsBuilder" class="builder-box"></div>
        <button onclick="addEntry('docs')" class="btn-primary" style="margin-top:10px;">+ Add Document</button>

        <label>Videos</label>
        <div id="videosBuilder" class="builder-box"></div>
        <button onclick="addEntry('videos')" class="btn-primary" style="margin-top:10px;">+ Add Video</button>

        <input type="number" id="m-progress" min="0" max="100" value="{{ plan.progress }}" style="margin-top:10px;">

        <button onclick="saveEdit()" class="btn-success" style="width:100%;margin-top:12px;">Save</button>
        <button onclick="closeEdit()" class="btn-danger" style="width:100%;margin-top:10px;">Cancel</button>
    </div>
</div>

<div class="modal" id="modalProgress">
    <div class="modal-content">
        <h3>Update Progress</h3>
        <input type="number" id="progress-input" min="0" max="100" value="{{ plan.progress }}">
        <button onclick="saveInternProgress()" class="btn-success" style="width:100%;margin-top:15px;">Save</button>
        <button onclick="closeInternProgressEdit()" class="btn-danger" style="width:100%;margin-top:10px;">Cancel</button>
    </div>
</div>

<script>
function showToast(msg, type="success") {
    const box = document.getElementById("toast");
    const d = document.createElement("div");
    d.className = `toast-msg toast-${type}`;
    d.innerText = msg;
    box.appendChild(d);
    setTimeout(() => d.remove(), 3000);
}

const CONFIG = {
    planId: {{ plan.id }},
    timeline: {{ plan.timeline | tojson }},
    resources: {{ plan.resources | tojson }},
    createdBy: {{ plan.created_by }},
    internId: {{ plan.intern_id }}
};

const state = { timeline: [], docs: [], videos: [] };

function parseData(d, fb=[]) {
    if (!d || d === "None") return fb;
    if (typeof d === "string") { try { return JSON.parse(d); } catch { return fb; } }
    return d;
}

function openEdit() {
    state.timeline = parseData(CONFIG.timeline, []);
    const r = parseData(CONFIG.resources, {});
    state.docs = r.docs || [];
    state.videos = r.videos || [];

    renderBuilder("timeline");
    renderBuilder("docs");
    renderBuilder("videos");

    document.getElementById("modalEdit").classList.add("show");
}

function closeEdit() {
    document.getElementById("modalEdit").classList.remove("show");
}

function addEntry(t) {
    if (t === "timeline") state.timeline.push({ date:"", title:"", note:"" });
    else state[t].push("");
    renderBuilder(t);
}

function removeEntry(t,i) {
    state[t].splice(i,1);
    renderBuilder(t);
}

function renderBuilder(t) {
    const box = document.getElementById(t+"Builder");
    const arr = state[t];
    if (!arr.length) { box.innerHTML = "<p>No data</p>"; return; }

    if (t === "timeline") {
        box.innerHTML = arr.map((e,i)=>`
            <div class="builder-entry">
                <input type="date" value="${e.date}" onchange="state.timeline[${i}].date=this.value">
                <input type="text" value="${e.title}" onchange="state.timeline[${i}].title=this.value">
                <input type="text" value="${e.note}" onchange="state.timeline[${i}].note=this.value">
                <button onclick="removeEntry('timeline',${i})" class="btn-remove">×</button>
            </div>
        `).join("");
    } else {
        box.innerHTML = arr.map((e,i)=>`
            <div class="builder-entry">
                <input type="url" value="${e}" onchange="state.${t}[${i}]=this.value">
                <button onclick="removeEntry('${t}',${i})" class="btn-remove">×</button>
            </div>
        `).join("");
    }
}

async function saveEdit() {
    const body = {
        title: document.getElementById("m-title").value,
        description: document.getElementById("m-description").value,
        objective: document.getElementById("m-objective").value,
        skills: document.getElementById("m-skills").value,
        progress: parseInt(document.getElementById("m-progress").value),
        timeline: JSON.stringify(state.timeline),
        resources: JSON.stringify({
            docs: state.docs.filter(x=>x.trim()),
            videos: state.videos.filter(x=>x.trim())
        }),
        intern_id: CONFIG.internId,
        created_by: CONFIG.createdBy
    };

    const r = await fetch(`/api/training-plans/${CONFIG.planId}`, {
        method:"PUT",
        headers:{
            "Content-Type":"application/json",
            "Authorization":"Bearer " + localStorage.getItem("token")
        },
        body:JSON.stringify(body)
    });

    if (r.ok) {
        showToast("Training plan updated", "success");
        setTimeout(()=>location.reload(),800);
    } else {
        showToast("Update failed", "error");
    }
}

async function deletePlan() {
    if (!confirm("Delete this training plan?")) return;

    const r = await fetch(`/api/training-plans/${CONFIG.planId}`, {
        method:"DELETE",
        headers:{
            "Authorization":"Bearer " + localStorage.getItem("token")
        }
    });

    if (r.ok) {
        showToast("Deleted", "success");
        setTimeout(()=>window.location.href="/training-plans",800);
    } else showToast("Delete failed","error");
}

function loadDisplay() {
    const t = parseData(CONFIG.timeline, []);
    const tb = document.getElementById("timelineBox");
    tb.innerHTML = t.length ? 
        t.map(i=>`
            <div class="timeline-item">
                <div>${i.date || ""}</div>
                <div>${i.title || ""}</div>
                <div>${i.note || ""}</div>
            </div>
        `).join("") : "<p>No timeline data.</p>";

    const r = parseData(CONFIG.resources, {});
    const rb = document.getElementById("resourceList");
    if ((!r.docs?.length) && (!r.videos?.length)) {
        rb.innerHTML = "<p>No resources</p>";
        return;
    }

    let html = "";
    if (r.docs?.length) {
        html += "<b>Documents:</b>";
        r.docs.forEach(l => html += `<li><a href="${l}" target="_blank">${l}</a></li>`);
    }
    if (r.videos?.length) {
        html += "<b style='margin-top:12px;display:block;'>Videos:</b>";
        r.videos.forEach(l => html += `<li><a href="${l}" target="_blank">${l}</a></li>`);
    }
    rb.innerHTML = html;
}

loadDisplay();

function openInternProgressEdit() {
    document.getElementById("modalProgress").classList.add("show");
}

function closeInternProgressEdit() {
    document.getElementById("modalProgress").classList.remove("show");
}

async function saveInternProgress() {
    const v = parseInt(document.getElementById("progress-input").value);
    if (isNaN(v) || v<0 || v>100) {
        showToast("Invalid progress", "error");
        return;
    }

    const r = await fetch(`/api/training-plans/${CONFIG.planId}`, {
        method:"PUT",
        headers:{
            "Content-Type":"application/json",
            "Authorization":"Bearer " + localStorage.getItem("token")
        },
        body:JSON.stringify({ progress:v })
    });

    if (r.ok) {
        showToast("Progress updated","success");
        setTimeout(()=>location.reload(),800);
    } else showToast("Update failed","error");
}
</script>

{% endblock %}
