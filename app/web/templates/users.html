{% extends "base.html" %}
{% set page_title = "Users" %}
{% block content %}

<div id="toast"></div>

<style>
    #toast {
        position: fixed;
        top: 20px;
        right: 20px;
        z-index: 99999;
        display: flex;
        flex-direction: column;
        gap: 10px;
    }

    .toast-msg {
        padding: 12px 16px;
        border-radius: 8px;
        background: #333;
        color: #fff;
        animation: fadein .2s ease, fadeout .35s ease 2.5s forwards;
    }

    .toast-success {
        background: #16a34a !important;
    }

    .toast-error {
        background: #dc2626 !important;
    }

    @keyframes fadein {
        from {
            opacity: 0;
            transform: translateY(-6px);
        }

        to {
            opacity: 1;
        }
    }

    @keyframes fadeout {
        from {
            opacity: 1;
        }

        to {
            opacity: 0;
            transform: translateY(-6px);
        }
    }
</style>

<div class="header">
    <h1><i class="fa-solid fa-users"></i> Users</h1>

    <div class="filter-row" id="filterRow">
        <input id="searchInput" placeholder="Search username..." oninput="filterUsers()">

        <select id="filterRole" onchange="filterUsers()">
            <option value="">Role (All)</option>
            <option value="ADMIN">Admin</option>
            <option value="TRAINER">Trainer</option>
            <option value="INTERN">Intern</option>
        </select>

        <button onclick="filterUsers()" class="btn-primary">Search</button>

        <button onclick="openCreateModal()" class="btn-success" id="btnAddUser">
            <i class="fa fa-plus"></i> Add User
        </button>
    </div>
</div>

<div class="card">
    <table id="userTable">
        <thead>
            <tr>
                <th>Username</th>
                <th>Email</th>
                <th>Role</th>
                <th>Active</th>
                <th>Created</th>
                <th width="160px">Actions</th>
            </tr>
        </thead>
        <tbody>
            {% for u in users %}
            <tr data-username="{{ u.username|lower }}" data-role="{{ u.role_name|upper }}">
                <td>{{ u.username }}</td>
                <td>{{ u.email }}</td>
                <td>{{ u.role_name or "-" }}</td>
                <td>
                    {% if u.is_active %}
                    <span class="badge-info">Active</span>
                    {% else %}
                    <span class="badge-danger">Inactive</span>
                    {% endif %}
                </td>
                <td>{{ u.created_at }}</td>
                <td>
                    <button class="btn-icon btn-view" onclick="window.location.href='/users/{{ u.id }}'">
                        <i class="fa-solid fa-eye"></i>
                    </button>

                    <button class="btn-icon btn-edit" data-id="{{ u.id }}" data-username="{{ u.username }}"
                        data-email="{{ u.email }}" data-role="{{ u.role_id if u.role_id else '' }}"
                        onclick="openEditModal(this)">
                        <i class="fa-solid fa-pen"></i>
                    </button>

                    <button class="btn-icon btn-delete" onclick="deleteUser('{{ u.id }}')">
                        <i class="fa-solid fa-trash"></i>
                    </button>
                </td>
            </tr>
            {% endfor %}
        </tbody>
    </table>
</div>

<div class="modal" id="userModal" onclick="handleBackdropClick(event)">
    <div class="modal-content" onclick="event.stopPropagation()">

        <h3 id="modalTitle">Create User</h3>

        <input id="username" placeholder="Username" required>
        <input id="email" placeholder="Email" type="email" required>
        <input id="password" placeholder="Password" type="password" required>

        <select id="role_id"></select>

        <div style="margin-top: 15px;">
            <button class="btn-success" onclick="saveUser()" id="saveBtn">Save</button>
            <button class="btn-danger" onclick="closeUserModal()">Cancel</button>
        </div>

    </div>
</div>

<script>
    let editingUserId = null;
    let ROLE_CACHE = [];

    // ⚠ TOAST FUNCTION — dùng chung toàn trang
    function showToast(msg, type = "success") {
        const box = document.getElementById("toast");
        const div = document.createElement("div");
        div.className = `toast-msg toast-${type}`;
        div.textContent = msg;
        box.appendChild(div);
        setTimeout(() => div.remove(), 3000);
    }

    function getAuthHeaders(json = true) {
        const token = localStorage.getItem("token");
        const headers = {};
        if (json) headers["Content-Type"] = "application/json";
        if (token) headers["Authorization"] = "Bearer " + token;
        return headers;
    }

    function filterUsers() {
        const q = document.getElementById("searchInput").value.trim().toLowerCase();
        const role = document.getElementById("filterRole").value;
        const rows = document.querySelectorAll("#userTable tbody tr");

        rows.forEach(tr => {
            const uname = tr.getAttribute("data-username") || "";
            const roleName = tr.getAttribute("data-role") || "";
            const matchName = !q || uname.includes(q);
            const matchRole = !role || roleName === role;
            tr.style.display = (matchName && matchRole) ? "" : "none";
        });
    }

    async function loadRoles() {
        try {
            const res = await fetch("/api/roles/", { headers: getAuthHeaders(false) });
            const data = await res.json();
            if (!res.ok) {
                showToast(data.error || "Failed loading roles", "error");
                return;
            }
            ROLE_CACHE = data;

            const sel = document.getElementById("role_id");
            sel.innerHTML = `<option value="">-- Select Role --</option>`;
            ROLE_CACHE.forEach(r => {
                sel.innerHTML += `<option value="${r.id}">${r.name}</option>`;
            });

        } catch (err) {
            showToast("Network error loading roles", "error");
        }
    }

    function openCreateModal() {
        editingUserId = null;
        document.getElementById("modalTitle").textContent = "Create User";

        document.getElementById("username").value = "";
        document.getElementById("email").value = "";
        document.getElementById("password").value = "";
        document.getElementById("password").required = true;
        document.getElementById("role_id").value = "";

        document.getElementById("userModal").style.display = "flex";
    }

    function openEditModal(btn) {
        editingUserId = btn.dataset.id;

        document.getElementById("modalTitle").textContent = "Update User";
        document.getElementById("username").value = btn.dataset.username;
        document.getElementById("email").value = btn.dataset.email;
        document.getElementById("password").value = "";
        document.getElementById("password").required = false;

        if (ROLE_CACHE.length === 0) {
            loadRoles().then(() => {
                document.getElementById("role_id").value = btn.dataset.role || "";
            });
        } else {
            document.getElementById("role_id").value = btn.dataset.role || "";
        }

        document.getElementById("userModal").style.display = "flex";
    }

    function closeUserModal() {
        document.getElementById("userModal").style.display = "none";
    }

    function handleBackdropClick(e) {
        if (e.target.id === "userModal") closeUserModal();
    }

    function validateEmail(email) {
        if (!email) return false;
        const p = /^[^\s@]+@[^\s@]+\.[^\s@]+$/;
        return p.test(email);
    }

    async function saveUser() {
        const btn = document.getElementById("saveBtn");
        btn.disabled = true;
        btn.textContent = "Saving...";

        try {
            const username = document.getElementById("username").value.trim();
            const email = document.getElementById("email").value.trim();
            const password = document.getElementById("password").value.trim();
            const role = document.getElementById("role_id").value;

            if (!username) return showToast("Username is required", "error");
            if (!validateEmail(email)) return showToast("Invalid email format", "error");
            if (!editingUserId && !password) return showToast("Password required", "error");

            const payload = { username, email, role_id: role ? parseInt(role) : null };
            if (!editingUserId || password) payload.password = password;

            const url = editingUserId ? `/api/users/${editingUserId}` : "/api/users/";
            const method = editingUserId ? "PUT" : "POST";

            const res = await fetch(url, {
                method,
                headers: getAuthHeaders(),
                body: JSON.stringify(payload)
            });

            const result = await res.json();

            if (res.ok) {
                showToast(editingUserId ? "User updated!" : "User created!", "success");
                closeUserModal();
                setTimeout(() => window.location.reload(), 500);
            } else {
                showToast(result.error || "Save failed", "error");
            }

        } catch (err) {
            showToast("Network error", "error");
        } finally {
            btn.disabled = false;
            btn.textContent = "Save";
        }
    }

    async function deleteUser(id) {
        if (!confirm("Delete this user?")) return;  /* ⚠ CHỖ NÀY THƯỜNG ĐƯỢC THAY BẰNG MODAL */

        try {
            const res = await fetch(`/api/users/${id}`, {
                method: "DELETE",
                headers: getAuthHeaders(false)
            });

            const result = await res.json();

            if (res.ok) {
                showToast("User deleted", "success");
                setTimeout(() => window.location.reload(), 500);
            } else {
                showToast(result.error || "Delete failed", "error");
            }

        } catch (err) {
            showToast("Network error", "error");
        }
    }

    document.addEventListener("DOMContentLoaded", () => {
        loadRoles();
        document.addEventListener("keydown", (e) => {
            if (e.key === "Escape") closeUserModal();
        });
    });
</script>

{% endblock %}