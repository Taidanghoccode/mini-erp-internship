{% extends "base.html" %}
{% set page_title = "Users" %}
{% block content %}

<div class="header">
    <h1><i class="fa-solid fa-users"></i> Users</h1>
</div>

<div class="card">

    <div class="filter-row" style="margin-bottom: 20px;">
        <input placeholder="Search username..." id="searchInput" oninput="filterUsers()">
        <button class="btn-primary" onclick="filterUsers()">Search</button>

        <button class="btn-success" onclick="openCreateModal()">
            + Add User
        </button>
    </div>

    <table id="userTable">
        <thead>
            <tr>
                <th>Username</th>
                <th>Email</th>
                <th>Role</th>
                <th>Active</th>
                <th>Created</th>
                <th width="160px">Actions</th>
            </tr>
        </thead>
        <tbody>
            {% for u in users %}
            <tr data-username="{{ u.username|lower }}">
                <td>{{ u.username }}</td>
                <td>{{ u.email }}</td>
                <td>{{ u.role_name or "-" }}</td>
                <td>
                    {% if u.is_active %}
                        <span class="badge-info">Active</span>
                    {% else %}
                        <span class="badge-danger">Inactive</span>
                    {% endif %}
                </td>
                <td>{{ u.created_at }}</td>
                <td>
                    <button class="btn-icon btn-view" onclick="window.location.href='/users/{{ u.id }}'">
                        <i class="fa-solid fa-eye"></i>
                    </button>
                    <button class="btn-icon btn-edit"
                        data-id="{{ u.id }}"
                        data-username="{{ u.username }}"
                        data-email="{{ u.email }}"
                        data-role="{{ u.role_id if u.role_id else '' }}"
                        onclick="openEditModal(this)">
                    <i class="fa-solid fa-pen"></i>
                    </button>

                    <button class="btn-icon btn-delete" onclick="deleteUser('{{ u.id }}')">
                        <i class="fa-solid fa-trash"></i>
                    </button>
                </td>
            </tr>
            {% endfor %}
        </tbody>
    </table>
</div>


<div class="modal" id="userModal" onclick="handleBackdropClick(event)">
    <div class="modal-content" onclick="event.stopPropagation()">

        <h3 id="modalTitle">Create User</h3>

        <input id="username" placeholder="Username" required>
        <input id="email" placeholder="Email" type="email" required>
        <input id="password" placeholder="Password" type="password" required>

        <select id="role_id"></select>

        <div style="margin-top: 15px;">
            <button class="btn-success" onclick="saveUser()" id="saveBtn">Save</button>
            <button class="btn-danger" onclick="closeUserModal()">Cancel</button>
        </div>

    </div>
</div>

<script>
let editingUserId = null;
let ROLE_CACHE = [];

function getAuthHeaders(json = true) {
    const token = localStorage.getItem("token");
    const headers = {};
    if (json) headers["Content-Type"] = "application/json";
    if (token) headers["Authorization"] = "Bearer " + token;
    return headers;
}

function filterUsers() {
    const q = document.getElementById("searchInput").value.trim().toLowerCase();
    const rows = document.querySelectorAll("#userTable tbody tr");
    rows.forEach(tr => {
        const uname = tr.getAttribute("data-username") || "";
        tr.style.display = (!q || uname.includes(q)) ? "" : "none";
    });
}

async function loadRoles() {
    try {
        const res = await fetch("/api/roles/", {
            headers: getAuthHeaders(false)
        });
        const data = await res.json();
        if (!res.ok) {
            alert("Error load roles: " + (data.error || "Failed"));
            return;
        }
        ROLE_CACHE = data;
        const select = document.getElementById("role_id");
        select.innerHTML = `<option value="">-- Select Role --</option>`;
        ROLE_CACHE.forEach(r => {
            select.innerHTML += `<option value="${r.id}">${r.name}</option>`;
        });
    } catch (err) {
        alert("Network error loading roles: " + err.message);
    }
}

function openCreateModal() {
    editingUserId = null;
    document.getElementById("modalTitle").textContent = "Create User";

    document.getElementById("username").value = "";
    document.getElementById("email").value = "";
    document.getElementById("password").value = "";
    document.getElementById("password").required = true;
    document.getElementById("role_id").value = "";

    document.getElementById("userModal").style.display = "flex";
}

function openEditModal(btn) {
    const id = btn.dataset.id;
    const username = btn.dataset.username;
    const email = btn.dataset.email;
    const roleId = btn.dataset.role;

    editingUserId = id;
    document.getElementById("modalTitle").textContent = "Update User";

    document.getElementById("username").value = username;
    document.getElementById("email").value = email;
    document.getElementById("password").value = "";
    document.getElementById("password").required = false;

    if (ROLE_CACHE.length === 0) {
        loadRoles().then(() => {
            document.getElementById("role_id").value = roleId || "";
        });
    } else {
        document.getElementById("role_id").value = roleId || "";
    }

    document.getElementById("userModal").style.display = "flex";
}

function closeUserModal() {
    document.getElementById("userModal").style.display = "none";
}

function handleBackdropClick(event) {
    if (event.target.id === "userModal") {
        closeUserModal();
    }
}

function validateEmail(email) {
    if (!email) return false;
    const pattern = /^[^\s@]+@[^\s@]+\.[^\s@]+$/;
    return pattern.test(email);
}

async function saveUser() {
    const saveBtn = document.getElementById("saveBtn");
    saveBtn.disabled = true;
    saveBtn.textContent = "Saving...";

    try {
        const username = document.getElementById("username").value.trim();
        const email = document.getElementById("email").value.trim();
        const password = document.getElementById("password").value.trim();
        const roleVal = document.getElementById("role_id").value;

        if (!username) {
            alert("Username is required");
            return;
        }
        if (!validateEmail(email)) {
            alert("Invalid email format");
            return;
        }
        if (!editingUserId && !password) {
            alert("Password is required for new user");
            return;
        }

        const payload = {
            username: username,
            email: email,
            role_id: roleVal ? parseInt(roleVal) : null
        };

        if (!editingUserId || password) {
            payload.password = password;
        }

        const url = editingUserId ? `/api/users/${editingUserId}` : "/api/users/";
        const method = editingUserId ? "PUT" : "POST";

        const res = await fetch(url, {
            method: method,
            headers: getAuthHeaders(),
            body: JSON.stringify(payload)
        });

        const result = await res.json();

        if (res.ok) {
            alert(editingUserId ? "User updated successfully!" : "User created successfully!");
            closeUserModal();
            window.location.reload();
        } else {
            alert("Error: " + (result.error || "Failed"));
        }

    } catch (e) {
        alert("Network error: " + e.message);
    } finally {
        saveBtn.disabled = false;
        saveBtn.textContent = "Save";
    }
}

async function deleteUser(id) {
    if (!confirm("Are you sure you want to delete this user?")) return;

    try {
        const res = await fetch(`/api/users/${id}`, {
            method: "DELETE",
            headers: getAuthHeaders(false)
        });

        const result = await res.json();

        if (res.ok) {
            alert("Deleted successfully");
            window.location.reload();
        } else {
            alert("Error: " + (result.error || "Failed"));
        }
    } catch (e) {
        alert("Network error: " + e.message);
    }
}

document.addEventListener("DOMContentLoaded", function () {
    loadRoles();
    document.addEventListener('keydown', function (event) {
        if (event.key === 'Escape') closeUserModal();
    });
});
</script>

{% endblock %}
