{% extends "base.html" %}
{% set page_title = "Feedback Management" %}
{% block content %}

<style>
.section-title {
    font-size: 20px;
    font-weight: 700;
    margin-bottom: 14px;
    color: #1f2937;
}
.table-wrapper { margin-top: 10px; }
.rating-10 { font-weight: 700; color:#2563eb; }
.star { color:#facc15; }
.btn-group { display:flex; gap:6px; }

.modal.hidden { display:none; }
.modal {
    position: fixed;
    top: 0; left: 0;
    width: 100%; height: 100%;
    background: rgba(0,0,0,0.4);
    display: flex;
    justify-content: center;
    align-items: center;
    z-index: 2000;
}
.modal-content {
    width: 450px;
    background: #fff;
    border-radius: 12px;
    padding: 20px;
}
.modal-header { display:flex; justify-content:space-between; align-items:center; }
.modal-close { cursor:pointer; font-size:20px; background:none; border:none; }
.form-group { margin-bottom:12px; }
.form-group label { display:block; margin-bottom:4px; font-weight:600; }
.form-group input, .form-group textarea {
    width:100%; padding:8px 10px; border:1px solid #ddd; border-radius:6px;
}

.toast-msg {
    padding: 12px 16px;
    border-radius: 8px;
    font-weight: 600;
    color: #fff;
    animation: fadein .2s, fadeout .35s 2.5s forwards;
    box-shadow: 0 4px 10px rgba(0,0,0,.15);
}
@keyframes fadein { from { opacity:0; transform:translateY(-6px);} to {opacity:1;} }
@keyframes fadeout { from {opacity:1;} to {opacity:0; transform:translateY(-6px);} }
</style>

<div id="toast" style="position:fixed; top:20px; right:20px; display:flex; flex-direction:column; gap:10px; z-index:99999;"></div>

<div class="header">
    <h1><i class="fa-solid fa-comments"></i> Feedback Management</h1>
</div>

<div class="card" style="margin-top:20px;">
    <div class="section-title"><i class="fa-solid fa-user-graduate"></i> Intern Feedback (10-point scale)</div>

    <div class="filter-row" style="display:flex; gap:12px; margin-bottom:10px;">
        <input id="internSearch" placeholder="Search comment...">
        <select id="internScoreFilter">
            <option value="">Score (All)</option>
            <option value="10">10</option>
            <option value="9">9</option>
            <option value="8">8</option>
            <option value="7">7</option>
            <option value="6">6</option>
            <option value="5">5</option>
            <option value="4">4</option>
            <option value="3">3</option>
            <option value="2">2</option>
            <option value="1">1</option>
        </select>
        <button class="btn-primary" onclick="applyInternFilter()">
            <i class="fa fa-filter"></i> Filter
        </button>
    </div>

    <table class="data-table" id="internFbTable">
        <thead>
            <tr>
                <th>Score</th>
                <th>Comment</th>
                <th>From</th>
                <th>Intern</th>
                <th>Created</th>
                <th width="120px">Actions</th>
            </tr>
        </thead>
        <tbody id="internFbBody"></tbody>
    </table>
</div>

<div class="card" style="margin-top:30px;">
    <div class="section-title"><i class="fa-solid fa-diagram-project"></i> Project Feedback (5★ rating)</div>

    <div class="filter-row" style="display:flex; gap:12px; margin-bottom:10px;">
        <select id="projTypeFilter">
            <option value="">All Types</option>
            <option value="INTERN_PROJECT">Intern → Project</option>
            <option value="TRAINER_PROJECT">Trainer → Project</option>
        </select>

        <select id="projScoreFilter">
            <option value="">Stars (All)</option>
            <option value="5">5 ★</option>
            <option value="4">4 ★</option>
            <option value="3">3 ★</option>
            <option value="2">2 ★</option>
            <option value="1">1 ★</option>
        </select>

        <input id="projSearch" placeholder="Search comment...">

        <button class="btn-primary" onclick="applyProjectFilter()">
            <i class="fa fa-filter"></i> Filter
        </button>
    </div>

    <table class="data-table" id="projectFbTable">
        <thead>
            <tr>
                <th>Type</th>
                <th>Score</th>
                <th>Comment</th>
                <th>From</th>
                <th>Project</th>
                <th>Created</th>
                <th width="120px">Actions</th>
            </tr>
        </thead>
        <tbody id="projectFbBody"></tbody>
    </table>
</div>

<div id="feedbackModal" class="modal hidden">
    <div class="modal-content">
        <div class="modal-header">
            <h2 id="modalTitle">Feedback Detail</h2>
            <button class="modal-close" onclick="closeModal()">&times;</button>
        </div>

        <div class="form-group"><label>Type</label><input id="modalType" readonly></div>
        <div class="form-group"><label>Score</label><input id="modalScore" type="number" readonly></div>
        <div class="form-group"><label>Comment</label><textarea id="modalComment" rows="3" readonly></textarea></div>
        <div class="form-group"><label>From</label><input id="modalFrom" readonly></div>
        <div class="form-group"><label>Target</label><input id="modalTarget" readonly></div>
        <div class="form-group"><label>Created</label><input id="modalCreated" readonly></div>

        <button class="btn-primary" id="saveBtn" style="display:none;">Save</button>
    </div>
</div>

<div id="deleteModal" class="modal hidden">
    <div class="modal-content">
        <h2>Delete Feedback</h2>
        <p>Are you sure you want to delete this feedback?</p>

        <button class="btn-danger" id="deleteConfirmBtn">Delete</button>
        <button class="btn-secondary" onclick="closeDelete()">Cancel</button>
    </div>
</div>

<script>
let allFeedback = [];
let currentFeedbackId = null;
let CAN_DELETE = false;

async function loadPermissions() {
    const p = JSON.parse(localStorage.getItem("permissions") || "[]");
    CAN_DELETE = p.includes("FEEDBACK_DELETE");
}

function showToast(msg, type="success") {
    const box = document.getElementById("toast");
    const div = document.createElement("div");
    div.className = "toast-msg";
    div.style.background =
        type === "success" ? "#16a34a" :
        type === "error"   ? "#dc2626" :
                             "#2563eb";
    div.textContent = msg;
    box.appendChild(div);
    setTimeout(() => div.remove(), 3000);
}

async function loadFeedback() {
    await loadPermissions();

    const res = await fetch("/api/feedback/all", { headers: authHeader() });
    const data = await res.json();
    allFeedback = data;

    renderIntern(data.filter(f => f.type === "TRAINER_INTERN"));
    renderProject(data.filter(f => f.type !== "TRAINER_INTERN"));
}

function renderIntern(list) {
    const tbody = document.getElementById("internFbBody");
    tbody.innerHTML = "";

    list.forEach(fb => {
        tbody.innerHTML += `
        <tr>
            <td class="rating-10">${fb.score}/10</td>
            <td>${fb.comment || "-"}</td>
            <td>${fb.from_user_name}</td>
            <td>Intern #${fb.to_intern_id}</td>
            <td>${fb.created_at.slice(0,10)}</td>
            <td class="btn-group">
                <button class="btn-icon btn-view" onclick="openView(${fb.id})"><i class="fa-solid fa-eye"></i></button>
                ${CAN_DELETE ? `<button class="btn-icon btn-delete" onclick="openDelete(${fb.id})"><i class="fa-solid fa-trash"></i></button>` : ""}
            </td>
        </tr>`;
    });
}

function renderProject(list) {
    const tbody = document.getElementById("projectFbBody");
    tbody.innerHTML = "";

    list.forEach(fb => {
        tbody.innerHTML += `
        <tr>
            <td>${fb.type}</td>
            <td>${renderStars(fb.score)}</td>
            <td>${fb.comment || "-"}</td>
            <td>${fb.from_user_name}</td>
            <td>Project #${fb.to_project_id}</td>
            <td>${fb.created_at.slice(0,10)}</td>
            <td class="btn-group">
                <button class="btn-icon btn-view" onclick="openView(${fb.id})"><i class="fa-solid fa-eye"></i></button>
                ${CAN_DELETE ? `<button class="btn-icon btn-delete" onclick="openDelete(${fb.id})"><i class="fa-solid fa-trash"></i></button>` : ""}
            </td>
        </tr>`;
    });
}

function applyInternFilter() {
    const text = document.getElementById("internSearch").value.toLowerCase();
    const score = document.getElementById("internScoreFilter").value;

    const list = allFeedback
        .filter(f => f.type === "TRAINER_INTERN")
        .filter(f => !score || f.score == score)
        .filter(f => !text || (f.comment || "").toLowerCase().includes(text));

    renderIntern(list);
}

function applyProjectFilter() {
    const type = document.getElementById("projTypeFilter").value;
    const score = document.getElementById("projScoreFilter").value;
    const text = document.getElementById("projSearch").value.toLowerCase();

    const list = allFeedback
        .filter(f => f.type !== "TRAINER_INTERN")
        .filter(f => !type || f.type === type)
        .filter(f => !score || f.score == score)
        .filter(f => !text || (f.comment || "").toLowerCase().includes(text));

    renderProject(list);
}

function renderStars(n) {
    let s = "";
    for (let i = 0; i < n; i++) s += `<i class="fa-solid fa-star star"></i>`;
    for (let i = n; i < 5; i++) s += `<i class="fa-regular fa-star"></i>`;
    return s;
}

function openView(id) {
    currentFeedbackId = id;
    fillModal(allFeedback.find(f => f.id == id));
    document.getElementById("saveBtn").style.display = "none";
    document.getElementById("modalScore").readOnly = true;
    document.getElementById("modalComment").readOnly = true;
    document.getElementById("feedbackModal").classList.remove("hidden");
}

function openEdit(id) { return; }

function fillModal(fb) {
    document.getElementById("modalType").value = fb.type;
    document.getElementById("modalScore").value = fb.score;
    document.getElementById("modalComment").value = fb.comment || "";
    document.getElementById("modalFrom").value = fb.from_user_name;
    document.getElementById("modalTarget").value =
        fb.to_intern_id ? `Intern #${fb.to_intern_id}` : `Project #${fb.to_project_id}`;
    document.getElementById("modalCreated").value = fb.created_at;
}

function closeModal() {
    document.getElementById("feedbackModal").classList.add("hidden");
}

function openDelete(id) {
    currentFeedbackId = id;
    document.getElementById("deleteModal").classList.remove("hidden");
}

function closeDelete() {
    document.getElementById("deleteModal").classList.add("hidden");
}

document.getElementById("deleteConfirmBtn").onclick = async function() {
    const res = await fetch(`/api/feedback/${currentFeedbackId}`, {
        method: "DELETE",
        headers: authHeader()
    });

    if (res.ok) {
        showToast("Feedback deleted", "success");
        closeDelete();
        loadFeedback();
    } else {
        showToast("Delete failed!", "error");
    }
};

function authHeader() {
    return {
        "Content-Type": "application/json",
        "Authorization": "Bearer " + localStorage.getItem("token")
    };
}

loadFeedback();
</script>

{% endblock %}
