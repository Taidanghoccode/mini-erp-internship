{% extends "base.html" %}
{% set page_title = "Dashboard" %}
{% block content %}

<div class="header">
  <h1><i class="fa-solid fa-gauge"></i> Dashboard Overview</h1>
</div>

<div class="stats-grid">
  <div class="stat-card">
    <h3><i class="fa-solid fa-user-graduate"></i> Interns</h3>
    <div class="number">{{ summary.total_interns }}</div>
    <p class="stat-sub">Total interns in system</p>
  </div>

  <div class="stat-card">
    <h3><i class="fa-solid fa-diagram-project"></i> Projects</h3>
    <div class="number">{{ summary.total_projects }}</div>
    <p class="stat-sub">Active & archived projects</p>
  </div>

  <div class="stat-card">
    <h3><i class="fa-solid fa-comments"></i> Feedbacks</h3>
    <div class="number">{{ summary.total_feedbacks }}</div>
    <p class="stat-sub">Total feedback records</p>
  </div>

  <div class="stat-card">
    <h3><i class="fa-solid fa-users"></i> Active Users</h3>
    <div class="number">{{ summary.active_users }}</div>
    <p class="stat-sub">Users can login & use ERP</p>
  </div>
</div>

<div class="stats-grid" style="margin-top: 18px;">
  <div class="stat-card">
    <h3><i class="fa-solid fa-star"></i> Intern Rating</h3>
    <div class="number">{{ intern_performance.average_intern_rating }}</div>
    <p class="stat-sub">Average intern rating (0 – 10)</p>
  </div>

  <div class="stat-card">
    <h3><i class="fa-solid fa-star-half-stroke"></i> Project Rating</h3>
    <div class="number">{{ project_quality.average_project_rating }}</div>
    <p class="stat-sub">Average project rating (1 – 5)</p>
  </div>
</div>

<div class="dashboard-grid">
  <div class="left-column">
    <div class="card">
      <div class="card-header">
        <h2><i class="fa-solid fa-diagram-project"></i> Top Projects</h2>
        <a href="/projects" class="card-title-link">View All</a>
      </div>

      {% if project_quality.top_projects %}
      {% for p in project_quality.top_projects %}
      <a href="/projects/{{ p.id }}" class="project-item">
        <div>
          <strong style="color: var(--fpt-blue);">{{ p.title }}</strong>
          <p style="color: var(--text-secondary); font-size: 14px;">
            {{ p.status|capitalize }} • {{ p.feedback_count }} feedbacks
          </p>
        </div>
        <div style="display:flex; align-items:center; gap:8px;">
          <span class="badge-info">
            <i class="fa-solid fa-star"></i> {{ p.average_rating }}/5
          </span>
        </div>
      </a>
      {% endfor %}
      {% else %}
      <p>No project data.</p>
      {% endif %}
    </div>

    <div class="card">
      <div class="card-header">
        <h2><i class="fa-solid fa-chart-line"></i> System KPIs</h2>
      </div>
      <canvas id="reportChart"></canvas>
    </div>

    <div>
      {% if current_user.role.code == "ADMIN" %}
      <div class="card">
        <div class="card-header">
          <h2><i class="fa-solid fa-clock-rotate-left"></i> Recent Activities</h2>
        </div>

        {% if activity_logs %}
        {% for log in activity_logs %}
        <div class="feedback-item">
          <div>
            <b>{{ log.user }}</b> — {{ log.action }}<br>
            <small>{{ log.details }}</small>
          </div>
          <div><small>{{ log.timestamp }}</small></div>
        </div>
        {% endfor %}
        {% else %}
        <p>No recent activity.</p>
        {% endif %}

      </div>
      {% endif %}
    </div>
</div>
    <div class="right-column">
      <div class="card">
        <div class="card-header">
          <h2><i class="fa-solid fa-user-graduate"></i> Top Interns</h2>
        </div>

        {% if intern_performance.top_interns %}
        {% for item in intern_performance.top_interns %}
        <div class="feedback-item">
          <div>
            <strong>{{ item.name }}</strong><br>
            <small>{{ item.email }}</small><br>
            <small>{{ item.feedback_count }} feedbacks</small>
          </div>
          <div class="badge-info">
            ⭐ {{ item.average_rating }}/10
          </div>
        </div>
        {% endfor %}
        {% else %}
        <p>No intern feedback yet.</p>
        {% endif %}
      </div>

    </div>

    <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
    <script>
      const summary = JSON.parse(`{{ summary | tojson | safe }}`);
      const internPerformance = JSON.parse(`{{ intern_performance | tojson | safe }}`);
      const projectQuality = JSON.parse(`{{ project_quality | tojson | safe }}`);

      const ctx = document.getElementById('reportChart');
      new Chart(ctx, {
        type: 'bar',
        data: {
          labels: ['Interns', 'Projects', 'Feedbacks', 'Intern Rating (0-10)', 'Project Rating (1-5)'],
          datasets: [{
            label: 'System KPIs',
            data: [
              summary.total_interns,
              summary.total_projects,
              summary.total_feedbacks,
              internPerformance.average_intern_rating,
              projectQuality.average_project_rating
            ],
            backgroundColor: [
              'rgba(0,91,170,0.6)',
              'rgba(0,150,64,0.6)',
              'rgba(243,112,33,0.6)',
              'rgba(54, 162, 235, 0.6)',
              'rgba(255, 206, 86, 0.6)'
            ],
            borderRadius: 8
          }]
        },
        options: {
          scales: { y: { beginAtZero: true } },
          plugins: { legend: { display: false } }
        }
      });
    </script>

    {% endblock %}