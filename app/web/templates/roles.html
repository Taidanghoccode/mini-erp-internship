{% extends "base.html" %}
{% set page_title = "Roles & Permissions" %}
{% block content %}

<style>
    #toast {
        position: fixed;
        top: 20px;
        right: 20px;
        z-index: 99999;
        display: flex;
        flex-direction: column;
        gap: 10px;
    }
    .toast-msg {
        padding: 12px 16px;
        border-radius: 8px;
        color: #fff;
        font-weight: 600;
        box-shadow: var(--shadow-md);
        animation: fadein .2s ease, fadeout .3s ease 2.5s forwards;
    }
    .toast-success { background:#16a34a; }
    .toast-error { background:#dc2626; }
    .toast-info { background:#2563eb; }

    @keyframes fadein { from{opacity:0; transform:translateY(-8px);} to{opacity:1;} }
    @keyframes fadeout { from{opacity:1;} to{opacity:0; transform:translateY(-8px);} }

    .modal { z-index:5000 !important; }
</style>

<div id="toast"></div>

<div class="header">
    <h1><i class="fa-solid fa-shield-halved"></i> Roles & Permissions</h1>

    <div class="filter-row">
        <button onclick="openCreateRoleModal()" class="btn-success">
            <i class="fa fa-plus"></i> Add Role
        </button>

        <button onclick="openCreatePermModal()" class="btn-success">
            <i class="fa fa-key"></i> Add Permission
        </button>
    </div>
</div>

<div class="card" style="display:flex; gap:24px; align-items:flex-start;">
    <div style="flex:1;">
        <h3 style="margin-bottom:10px;">Roles</h3>

        <table id="roleTable">
            <thead>
                <tr>
                    <th>Name</th>
                    <th>Code</th>
                    <th>Description</th>
                    <th width="120px">Actions</th>
                </tr>
            </thead>
            <tbody id="roleBody"></tbody>
        </table>
    </div>

    <div style="flex:1;">

        <div class="filter-row" style="margin-bottom:10px;">
            <input id="permSearch" placeholder="Search permission..." oninput="renderPermissionsForCurrent()">
        </div>

        <table id="permTable">
            <thead>
                <tr>
                    <th>Name</th>
                    <th>Code</th>
                    <th>Assigned</th>
                    <th width="120px">Actions</th>
                </tr>
            </thead>
            <tbody id="permBody"></tbody>
        </table>
    </div>
</div>

<!-- Role Modal -->
<div class="modal" id="roleModal">
    <div class="modal-content">
        <h3 id="roleModalTitle">Add Role</h3>

        <input id="roleName" placeholder="Role name">
        <input id="roleCode" placeholder="Role code">
        <textarea id="roleDesc" placeholder="Description" rows="3"></textarea>

        <button onclick="saveRole()" class="btn-success" style="width:100%; margin-top:10px;">Save</button>
        <button onclick="closeRoleModal()" class="btn-danger" style="width:100%; margin-top:10px;">Cancel</button>
    </div>
</div>

<!-- Permission Modal -->
<div class="modal" id="permModal">
    <div class="modal-content">
        <h3 id="permModalTitle">Add Permission</h3>

        <input id="permName" placeholder="Permission name">
        <input id="permCode" placeholder="Permission code">
        <textarea id="permDesc" placeholder="Description" rows="3"></textarea>

        <button onclick="savePerm()" class="btn-success" style="width:100%; margin-top:10px;">Save</button>
        <button onclick="closePermModal()" class="btn-danger" style="width:100%; margin-top:10px;">Cancel</button>
    </div>
</div>

<script>
function showToast(msg, type="success"){
    const box=document.getElementById("toast");
    const div=document.createElement("div");
    div.className=`toast-msg toast-${type}`;
    div.innerHTML=msg;
    box.appendChild(div);
    setTimeout(()=>div.remove(),3000);
}

const api = {
    roles:"/api/roles/",
    role:id=>`/api/roles/${id}`,
    perms:"/api/permissions/",
    perm:id=>`/api/permissions/${id}`,
    rpAssign:(roleId,permId)=>`/api/roles/${roleId}/permissions/${permId}`
};

let ROLES=[];
let PERMS=[];
let currentRoleId=null;
let editingRoleId=null;
let editingPermId=null;

function authHeader(){
    return {
        "Content-Type":"application/json",
        "Authorization":"Bearer " + localStorage.getItem("token")
    };
}

async function safeJson(res){
    if(!res.ok){
        let d=null;
        try{ d=await res.json(); }catch(_){}
        const msg=(d && (d.error || d.message)) || `Failed (${res.status})`;
        showToast(msg,"error");
        throw new Error(msg);
    }
    return res.json();
}

async function loadData(){
    try{
        const [r,p]=await Promise.all([
            fetch(api.roles,{headers:authHeader()}),
            fetch(api.perms,{headers:authHeader()})
        ]);

        ROLES=await safeJson(r);
        PERMS=await safeJson(p);
        renderRoles();
        renderPermissionsForCurrent();
    }catch(e){ console.error(e); }
}

function renderRoles(){
    const tbody=document.getElementById("roleBody");
    tbody.innerHTML="";

    if(ROLES.length===0){
        tbody.innerHTML=`<tr><td colspan="4" style="text-align:center;color:#6b7280;">No roles found</td></tr>`;
        return;
    }

    ROLES.forEach(r=>{
        tbody.innerHTML+=`
            <tr ${r.id===currentRoleId ? 'style="background:#f8fafc;"' : ''}>
                <td>${r.name}</td>
                <td>${r.code}</td>
                <td>${r.description||"-"}</td>
                <td>
                    <button class="btn-icon btn-view" onclick="viewRole(${r.id})"><i class="fa-solid fa-eye"></i></button>
                    <button class="btn-icon btn-edit" onclick="openEditRoleModal(${r.id})"><i class="fa-solid fa-pen"></i></button>
                    <button class="btn-icon btn-delete" onclick="deleteRole(${r.id})"><i class="fa-solid fa-trash"></i></button>
                </td>
            </tr>
        `;
    });
}

function viewRole(id){
    currentRoleId=id;
    const r=ROLES.find(x=>x.id===id);
    
    renderRoles();
    renderPermissionsForCurrent();
}

function renderPermissionsForCurrent(){
    const tbody=document.getElementById("permBody");
    tbody.innerHTML="";

    if(!currentRoleId){
        tbody.innerHTML=`<tr><td colspan="4" style="text-align:center;color:#6b7280;">Select a role</td></tr>`;
        return;
    }

    const role=ROLES.find(x=>x.id===currentRoleId);
    const assigned=new Set(role.permissions||[]);
    const keyword=document.getElementById("permSearch").value.trim().toLowerCase();

    let list=PERMS.filter(p =>
        !keyword ||
        p.name.toLowerCase().includes(keyword) ||
        p.code.toLowerCase().includes(keyword)
    );

    if(list.length===0){
        tbody.innerHTML=`<tr><td colspan="4" style="text-align:center;color:#6b7280;">No permissions found</td></tr>`;
        return;
    }

    list.forEach(p=>{
        const checked=assigned.has(p.code)?"checked":"";
        tbody.innerHTML+=`
            <tr>
                <td>${p.name}</td>
                <td>${p.code}</td>
                <td style="text-align:center;"><input type="checkbox" ${checked} onchange="toggleRolePermission(${p.id},this.checked)"></td>
                <td>
                    <button class="btn-icon btn-edit" onclick="openEditPermModal(${p.id})"><i class="fa-solid fa-pen"></i></button>
                    <button class="btn-icon btn-delete" onclick="deletePerm(${p.id})"><i class="fa-solid fa-trash"></i></button>
                </td>
            </tr>
        `;
    });
}

function openCreateRoleModal(){
    editingRoleId=null;
    roleName.value="";
    roleCode.value="";
    roleDesc.value="";
    roleModal.style.display="flex";
}

function openEditRoleModal(id){
    editingRoleId=id;
    const r=ROLES.find(x=>x.id===id);
    roleName.value=r.name;
    roleCode.value=r.code;
    roleDesc.value=r.description||"";
    roleModal.style.display="flex";
}

function closeRoleModal(){ roleModal.style.display="none"; }

async function saveRole(){
    const data={
        name:roleName.value.trim(),
        code:roleCode.value.trim().toUpperCase(),
        description:roleDesc.value.trim()
    };
    if(!data.name||!data.code){ showToast("Missing field","error"); return; }

    try{
        const url=editingRoleId ? api.role(editingRoleId) : api.roles;
        const method=editingRoleId ? "PUT" : "POST";

        const res=await fetch(url,{
            method, headers:authHeader(), body:JSON.stringify(data)
        });
        await safeJson(res);

        showToast(editingRoleId?"Updated":"Created");
        closeRoleModal();
        loadData();
    }catch(e){ console.error(e); }
}

async function deleteRole(id){
    if(!confirm("Delete this role?")) return;
    try{
        const res=await fetch(api.role(id),{ method:"DELETE",headers:authHeader() });
        await safeJson(res);
        if(currentRoleId===id) currentRoleId=null;
        showToast("Deleted","info");
        loadData();
    }catch(e){ console.error(e); }
}

function openCreatePermModal(){
    editingPermId=null;
    permName.value="";
    permCode.value="";
    permDesc.value="";
    permModal.style.display="flex";
}

function openEditPermModal(id){
    editingPermId=id;
    const p=PERMS.find(x=>x.id===id);
    permName.value=p.name;
    permCode.value=p.code;
    permDesc.value=p.description||"";
    permModal.style.display="flex";
}

function closePermModal(){ permModal.style.display="none"; }

async function savePerm(){
    const data={
        name:permName.value.trim(),
        code:permCode.value.trim().toUpperCase(),
        description:permDesc.value.trim()
    };
    if(!data.name||!data.code){ showToast("Missing field","error"); return; }

    try{
        const url=editingPermId ? api.perm(editingPermId) : api.perms;
        const method=editingPermId ? "PUT" : "POST";

        const res=await fetch(url,{
            method, headers:authHeader(), body:JSON.stringify(data)
        });
        await safeJson(res);

        showToast(editingPermId?"Updated":"Created");
        closePermModal();
        loadData();
    }catch(e){ console.error(e); }
}

async function deletePerm(id){
    if(!confirm("Delete this permission?")) return;
    try{
        const res=await fetch(api.perm(id),{ method:"DELETE",headers:authHeader() });
        await safeJson(res);
        showToast("Deleted","info");
        loadData();
    }catch(e){ console.error(e); }
}

async function toggleRolePermission(permId,checked){
    if(!currentRoleId){ showToast("Select role","error"); return; }

    try{
        const method=checked?"POST":"DELETE";
        const res=await fetch(api.rpAssign(currentRoleId,permId),{ method,headers:authHeader() });
        await safeJson(res);

        const r=await fetch(api.role(currentRoleId),{headers:authHeader()});
        const update=await safeJson(r);
        const idx=ROLES.findIndex(x=>x.id===currentRoleId);
        ROLES[idx]=update;

        showToast(checked?"Assigned":"Removed");
        renderPermissionsForCurrent();
    }catch(e){ console.error(e); }
}

loadData();
</script>

{% endblock %}
