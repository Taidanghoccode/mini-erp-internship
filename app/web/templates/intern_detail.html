{% extends "base.html" %}
{% set page_title = "Intern Detail" %}
{% block content %}

<div id="toast" style="
    position: fixed;
    top: 20px;
    right: 20px;
    z-index: 99999;
    display: flex;
    flex-direction: column;
    gap: 10px;
"></div>

<script>
    function showToast(message, type = "success") {
        const toast = document.getElementById("toast");
        const t = document.createElement("div");

        const colors = {
            success: "#16a34a",
            error: "#dc2626",
            info: "#2563eb"
        };

        t.style.background = colors[type];
        t.style.color = "#fff";
        t.style.padding = "12px 16px";
        t.style.borderRadius = "6px";
        t.style.fontWeight = "600";
        t.style.boxShadow = "0 2px 6px rgba(0,0,0,0.2)";
        t.style.opacity = "0";
        t.style.transition = "all .3s ease";
        t.innerText = message;

        toast.appendChild(t);

        setTimeout(() => { t.style.opacity = 1; }, 10);
        setTimeout(() => {
            t.style.opacity = 0;
            setTimeout(() => t.remove(), 300);
        }, 2600);
    }
</script>

<div class="header">
    <h1><i class="fa-solid fa-user-graduate"></i> Intern: {{ intern.name }}</h1>
</div>

<div style="display:grid;grid-template-columns:1fr 1fr;gap:20px;align-items:flex-start;">

    <div>
        <div class="card">
            <h3>Profile</h3>
            <table class="detail-table">
                <tr>
                    <th>Name</th>
                    <td>{{ intern.name }}</td>
                </tr>
                <tr>
                    <th>Email</th>
                    <td>{{ intern.email }}</td>
                </tr>
                <tr>
                    <th>University</th>
                    <td>{{ intern.university or '-' }}</td>
                </tr>
                <tr>
                    <th>Major</th>
                    <td>{{ intern.major or '-' }}</td>
                </tr>
                <tr>
                    <th>Start Date</th>
                    <td>{{ intern.start_date }}</td>
                </tr>
                <tr>
                    <th>End Date</th>
                    <td>{{ intern.end_date or '-' }}</td>
                </tr>
            </table>
        </div>
    </div>

    <div>
        <div class="card">

            <div style="display:flex;justify-content:space-between;align-items:center;margin-bottom:15px;">
                <h3>Feedback</h3>

                <button id="btnEvaluate" class="btn-primary" data-permission="EVALUATE_INTERN">
                    <i class="fa-solid fa-star"></i> Evaluate
                </button>

                {% if not intern.end_date %}
                <button id="btnCloseInternship" class="btn-danger">
                    Close Internship
                </button>
                {% endif %}
            </div>

            <div id="feedbackStats" style="background:#f3f4f6;padding:10px;border-radius:4px;
                        margin-bottom:15px;text-align:center;">
            </div>

            <table id="tblFeedback">
                <thead>
                    <tr>
                        <th>Reviewer</th>
                        <th>Score</th>
                        <th>Comment</th>
                        <th>Date</th>
                        <th data-permission="FEEDBACK_DELETE">Actions</th>
                    </tr>
                </thead>
                <tbody>
                    <tr>
                        <td colspan="5" class="text-center">Loading...</td>
                    </tr>
                </tbody>
            </table>
        </div>
    </div>
</div>

<div id="modalEvaluate" class="modal">
    <div class="modal-content">
        <h3><i class="fa-solid fa-star"></i> Evaluate Intern</h3>

        <form id="frmEvaluate">

            <label>Score (0-10)</label>
            <input type="number" name="score" min="0" max="10" step="1" required style="width:120px;">

            <label>Comment (max 100 chars)</label>
            <textarea name="comment" maxlength="100" rows="3"></textarea>
            <small><span id="cnt">0</span>/100</small>

            <div id="errEval" class="err"></div>

            <div class="modal-actions">
                <button type="button" class="btn-secondary close">Cancel</button>
                <button type="submit" class="btn-primary">Submit</button>
            </div>

        </form>
    </div>
</div>

<style>
    .modal {
        display: none;
        position: fixed;
        top: 0;
        left: 0;
        width: 100%;
        height: 100%;
        background: rgba(0, 0, 0, 0.5);
        align-items: center;
        justify-content: center;
        z-index: 1000;
    }

    .modal-content {
        background: #fff;
        padding: 25px;
        border-radius: 8px;
        max-width: 450px;
        width: 90%;
        max-height: 90vh;
        overflow-y: auto;
    }

    .err {
        color: #dc2626;
        margin-top: 8px;
    }

    .text-center {
        text-align: center;
    }
</style>

<script>
    const UID = "{{ current_user.id }}";
    const INTERN_ID = "{{ intern.id }}";

    let userFeedback = null;

    document.addEventListener("click", e => {
        if (e.target.classList.contains("close") || e.target.classList.contains("modal"))
            e.target.closest(".modal").style.display = "none";
    });

    function openModal(id) {
        document.getElementById(id).style.display = "flex";
    }

    const txt = document.querySelector("#frmEvaluate textarea");
    const cnt = document.getElementById("cnt");
    if (txt) txt.oninput = () => cnt.textContent = txt.value.length;


    async function loadFeedback() {
        try {
            const res = await fetch(`/api/feedback/intern/${INTERN_ID}`, {
                headers: { "Authorization": "Bearer " + localStorage.getItem("token") }
            });
            const data = await res.json();

            const tb = document.querySelector("#tblFeedback tbody");
            const stats = document.getElementById("feedbackStats");

            tb.innerHTML = "";

            if (!Array.isArray(data) || !data.length) {
                tb.innerHTML = `<tr><td colspan="5" class="text-center">No feedback yet</td></tr>`;
                stats.innerHTML = `<span style="color:#999;">No feedback yet</span>`;
                userFeedback = null;

                const btnEval = document.getElementById("btnEvaluate");
                if (btnEval) btnEval.style.display = "inline-block";

                applyPermissionUI();
                return;
            }

            userFeedback = data.find(f => f.from_user_id == UID);

            const total = data.reduce((s, f) => s + (f.score || 0), 0);
            const avg = (total / data.length).toFixed(1);

            stats.innerHTML = `
            <div style="font-size:20px;font-weight:bold;">${avg}/10</div>
            <div>${data.length} feedback</div>
        `;

            data.forEach(f => {
                tb.innerHTML += `
                <tr class="editable-feedback"
                     data-id="${f.id}"
                     data-score="${f.score}"
                     data-comment="${f.comment || ''}">
                    <td>${f.from_user_name || ("User #" + f.from_user_id)}</td>
                    <td><b>${f.score}</b>/10</td>
                    <td>${f.comment || '-'}</td>
                    <td>${new Date(f.created_at).toLocaleDateString()}</td>
                    <td data-permission="FEEDBACK_DELETE">
                        <button class="btn-danger btn-sm del" data-id="${f.id}">Delete</button>
                    </td>
                </tr>
            `;
            });

            document.querySelectorAll(".del").forEach(btn => {
                btn.onclick = async e => {
                    e.stopPropagation();
                    if (!confirm("Delete this feedback?")) return;

                    const res = await fetch(`/api/feedback/${btn.dataset.id}`, {
                        method: "DELETE",
                        headers: { "Authorization": "Bearer " + localStorage.getItem("token") }
                    });

                    const err = await res.json();
                    if (!res.ok) {
                        showToast(err.error || "Delete failed", "error");
                        return;
                    }

                    showToast("Feedback deleted", "info");
                    loadFeedback();
                };
            });

            document.querySelectorAll(".editable-feedback").forEach(row => {
                row.onclick = () => {
                    if (!userFeedback || row.dataset.id != userFeedback.id) return;

                    document.querySelector("#frmEvaluate input[name='score']").value = row.dataset.score;
                    document.querySelector("#frmEvaluate textarea").value = row.dataset.comment;
                    cnt.textContent = row.dataset.comment.length;

                    openModal("modalEvaluate");
                };
            });

            const btnEval = document.getElementById("btnEvaluate");
            if (btnEval) {
                btnEval.style.display = userFeedback ? "none" : "inline-block";
            }

            applyPermissionUI();

        } catch {
            showToast("Failed to load feedback", "error");
        }
    }


    document.getElementById("btnEvaluate")?.addEventListener("click", () => {
        userFeedback = null;
        document.querySelector("#frmEvaluate input[name='score']").value = "";
        document.querySelector("#frmEvaluate textarea").value = "";
        cnt.textContent = "0";
        openModal("modalEvaluate");
    });


    document.getElementById("frmEvaluate").onsubmit = async e => {
        e.preventDefault();

        const fd = new FormData(e.target);
        const payload = {
            intern_id: INTERN_ID,
            score: +fd.get("score"),
            comment: fd.get("comment") || ""
        };

        let url = "/api/feedback/trainer/intern";
        let method = "POST";

        if (userFeedback) {
            url = `/api/feedback/${userFeedback.id}`;
            method = "PUT";
        }

        const res = await fetch(url, {
            method,
            headers: {
                "Content-Type": "application/json",
                "Authorization": "Bearer " + localStorage.getItem("token")
            },
            body: JSON.stringify(payload)
        });

        const result = await res.json();

        if (!res.ok) {
            showToast(result.error || "Failed to save feedback", "error");
            return;
        }

        showToast("Saved successfully");
        document.getElementById("modalEvaluate").style.display = "none";
        loadFeedback();
    };


    document.addEventListener("DOMContentLoaded", loadFeedback);


    document.getElementById("btnCloseInternship")?.addEventListener("click", async () => {
        if (!confirm("Close this internship?")) return;

        const res = await fetch(`/api/interns/${INTERN_ID}/close`, {
            method: "POST",
            headers: {
                "Authorization": "Bearer " + localStorage.getItem("token"),
                "Content-Type": "application/json"
            }
        });

        const data = await res.json();

        if (!res.ok) {
            showToast(data.error || "Failed", "error");
            return;
        }

        showToast("Internship closed");
        setTimeout(() => location.reload(), 700);
    });
</script>

{% endblock %}